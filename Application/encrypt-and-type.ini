[Command]
Command="
    copyq:
    // Safely types in decrypted item text without using clipboard
    // (simulates key presses).
    // Requires \"xdotool\".
    var maxChars = 1
    var delayBeetweenKeystrokesMs = 10

    function typeText(slice) {
        var result = execute(
            'xdotool',
            'type',
            '--file', '-',
            '--delay', delayBeetweenKeystrokesMs,
            null,
            slice)

        if (!result) {
            throw 'Failed to type text'
        }

        if (result.exit_code != 0) {
            throw 'Failed to type text: ' + result.stderr
        }
    }

    function isModifierPressed() {
        var modifiers = queryKeyboardModifiers()
        return modifiers.length > 0
    }

    while (isModifierPressed()) {
        sleep(20)
    }

    var data = plugins.itemencrypted.decrypt(input())
    var item = unpack(data)
    var text = str(item[mimeText])
    if (!text) {
        abort()
    }

    hide()

    try {
        for (var i = 0; i < text.length; i += maxChars) {
            if (isModifierPressed()) {
                throw 'Typing interrupted'
            }

            typeText( text.slice(i, i + maxChars) )
        }
    } catch (e) {
        popup(e)
    }"
Icon=\xf13e
InMenu=true
Input=application/x-copyq-encrypted
Name=Decrypt and Type
Shortcut=return
